---
title: "Analysis of disyllabic Lexical Compound & Modifier-Head phrases citation tone
  sandhi patterns in Xiangshan"
output: html_document
date: "2024-04-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyverse)
library(kableExtra) 
library(ggplot2)
library(gridExtra) 
library(ggthemes)
library(viridis)
library(plotly)
library(ggrepel)
library(kml)
```

# Data preparations  
```{r data-construction, cache=FALSE}
load("XSTSF_production.RData")
source('functions.R')

f0_all_ct <- f0_all_pre %>% filter(focus_condition == 'ct' ) %>% 
  group_by(speaker) %>% 
  mutate(norm_f0 = scale(log(f0))) %>% 
  ungroup()

f0_di_ct_lcmh <- f0_all_ct %>% 
  filter(syntax %in% c('L', 'M') & diortri == 'di') %>% 
  mutate(sandhi_tone = case_when(sandhi_tone == 'HLLM' ~ 'HMML',
                                 sandhi_tone == 'LLHL' ~ 'LLRF', 
                                 .default = sandhi_tone)) %>% 
  filter(!ind_no %in% c('S2_1_ct', 'S2_11_ct', 'S2_27_ct', 'S3_5_ct', 'S3_19_ct', 'S5_27_ct',
                        'S2_44_ct', 'S3_37_ct', 'S3_44_ct', 'S6_16_ct', 'S6_31_ct', 'S6_39_ct', 'S7_33_ct')) %>% 
  filter(is.na(sandhi_tone) == FALSE) 
  
f0_di_ct_lcmh_h <- f0_di_ct_lcmh %>% filter( grepl('^H', sync_tone1))
f0_di_ct_lc_h <- f0_di_ct_lcmh_h %>% filter(syntax == 'L')
f0_di_ct_mh_h <- f0_di_ct_lcmh_h %>% filter(syntax == 'M')
f0_di_ct_lcmh_l <- f0_di_ct_lcmh %>% filter( grepl('^[LR]', sync_tone1))
f0_di_ct_lc_l <- f0_di_ct_lcmh_l %>% filter(syntax == 'L')
f0_di_ct_mh_l <- f0_di_ct_lcmh_l %>% filter(syntax == 'M')
```


# Initial data inspection

```{r fig.height=8}
# yinping-initial LC & MH
f0_di_ct_lcmh_hp <- f0_di_ct_lcmh_h %>% filter(hist_tone1 == 'yinping')
ggplotly(draw_by(f0_di_ct_lcmh_hp, 'speaker'), tooltip = c('text', 'x'))

# yinshang-initial LC & MH
f0_di_ct_lcmh_hs <- f0_di_ct_lcmh_h %>% filter(hist_tone1 == 'yinshang')
ggplotly(draw_by(f0_di_ct_lcmh_hs, 'speaker'), tooltip = c('text', 'x'))

# yangping-initial LC & MH
f0_di_ct_lcmh_lp <- f0_di_ct_lcmh_l %>% filter(hist_tone1 == 'yangping')
ggplotly(draw_by(f0_di_ct_lcmh_lp, 'speaker'), tooltip = c('text', 'x'))

# yangshang-initial LC & MH
f0_di_ct_lcmh_ls <- f0_di_ct_lcmh_l %>% filter(hist_tone1 == 'yangshang')
ggplotly(draw_by(f0_di_ct_lcmh_ls, 'speaker'), tooltip = c('text', 'x'))
```


# Perceptual categorisation
```{r, warning=FALSE, message=FALSE}
unique(f0_di_ct_lcmh_l$sandhi_tone) # check the labels

p_cluster(f0_di_ct_lcmh_l, sandhi_tone)
```

# Distribution analysis  

```{r}
# monosyllabic tone (initial tone)
distri_count(f0_di_ct_lcmh_l, speaker, sync_tone1)
distri_count(f0_di_ct_lcmh_l, hist_tone1, sync_tone1)

# by second tone
distri_count(f0_di_ct_lcmh_l, sync_tone2, sandhi_tone)
distri_count(f0_di_ct_lcmh_l, sync_tone2, sandhi_tone, hist_tone1)
distri_count(f0_di_ct_lc_l, sync_tone2, sandhi_tone)+ggtitle('Lexical compounds')
distri_count(f0_di_ct_mh_l, sync_tone2, sandhi_tone)+ggtitle('Adjective-Noun phrases')
distri_count(f0_di_ct_lcmh_l, hist_tone2, sandhi_tone)

# by first tone
distri_count(f0_di_ct_lcmh_l, sync_tone1, sandhi_tone)
distri_count(f0_di_ct_lcmh_l, hist_tone1, sandhi_tone)
distri_count(f0_di_ct_lcmh_l, hist_tone1, sandhi_tone, syntax)

# by speaker
distri_count(f0_di_ct_lcmh_l, speaker, sandhi_tone, hist_tone1)

# by item
distri_count(f0_di_ct_lcmh_lp, citation_no, sandhi_tone)
distri_count(f0_di_ct_lcmh_ls, citation_no, sandhi_tone)
```



# k-means clustering analysis

L-register LC & MH
```{r}
# data preparation
f0_di_ct_lcmh_l_kmeans <- f0_di_ct_lcmh_l %>% 
  select(-diortri, -syllable_no, -focus_no, -f0, -groupvar, -propdur) %>% 
  spread(normtime, norm_f0)

# k-means clustering
cluster_model <- k_means_clustering(f0_di_ct_lcmh_l_kmeans)
kml::plot(cluster_model, 5, parTraj=parTRAJ(col="clusters"))

# get cluster results
f0_di_ct_lcmh_l_kmeans <- f0_di_ct_lcmh_l_kmeans %>% 
  mutate(cluster3 = getClusters(cluster_model, 3),
         sub_cluster = paste0(sandhi_tone, '_', cluster3))

# heatmap distribution
cluster_solution <- get_cluster_solution(f0_di_ct_lcmh_l_kmeans)
heatmap_df <- heatmap_data(cluster_solution, cluster3)
compare_cluster(heatmap_df, 'cluster3')
```
```{r}
# examine mismathes
cluster_llrf <- cluster_solution %>% filter(sandhi_tone == 'LLRF')
ggplotly(p_cluster(cluster_llrf, sub_cluster), tooltip = c('text', 'x'))

cluster_lllm <- cluster_solution %>% filter(sandhi_tone == 'LLLM')
ggplotly(p_cluster(cluster_lllm, sub_cluster), tooltip = c('text', 'x'))
```

```{r, include=FALSE}
# try doing k-means for the whole disyllabic citation dataset
f0_di_ct_lcmh_kmeans <- f0_di_ct_lcmh %>% 
  filter(!sandhi_tone %in% c(NA, 'outlier')) %>% 
  select(-diortri, -syllable_no, -focus_no, -f0) %>% 
  spread(normtime, norm_f0)

f0_di_ct_lcmh_cluster <- k_means(f0_di_ct_lcmh_kmeans)
kml(f0_di_ct_lcmh_cluster, nbClusters = 2:10) 
plot(f0_di_ct_lcmh_cluster, 7, parTraj=parTRAJ(col="clusters"))

f0_di_ct_lcmh_kmeans <- f0_di_ct_lcmh_kmeans %>% 
  mutate(cluster7 = getClusters(f0_di_ct_lcmh_cluster, 7))

# Mapping between human and machine clustering
cluster_solution <- get_cluster_solution(f0_di_ct_lcmh_kmeans)
compare_cluster(cluster_solution, 'cluster7')
```
